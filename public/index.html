<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loggy - Monitor Konkurencji</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    h1 {
      color: #333;
      margin-bottom: 30px;
    }
    
    .nav {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .nav button {
      padding: 10px 20px;
      border: 2px solid #007bff;
      background: white;
      color: #007bff;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .nav button:hover {
      background: #007bff;
      color: white;
    }
    
    .nav button.active {
      background: #007bff;
      color: white;
    }
    
    .view {
      display: none;
    }
    
    .view.active {
      display: block;
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .table-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #f8f9fa;
    }
    
    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid #dee2e6;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-ok {
      background: #d4edda;
      color: #155724;
    }
    
    .status-enemy {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-error {
      background: #fff3cd;
      color: #856404;
    }
    
    .checkbox-cell {
      text-align: center;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    textarea {
      width: 100%;
      min-height: 400px;
      padding: 15px;
      border: 2px solid #dee2e6;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #007bff;
    }
    
    .info {
      margin-top: 10px;
      padding: 10px;
      background: #e7f3ff;
      border-left: 4px solid #007bff;
      color: #004085;
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .url-cell {
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .url-link {
      color: #007bff;
      text-decoration: none;
    }
    
    .url-link:hover {
      text-decoration: underline;
    }
    
    .comment-cell {
      max-width: 400px;
    }
    
    .comment-input {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
      background: white;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .comment-input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    .comment-input::placeholder {
      color: #999;
      font-style: italic;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      flex: 1;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #007bff;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 14px;
      margin-top: 5px;
    }
    
    .btn-delete {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    
    .btn-delete:hover {
      background-color: #f8d7da;
    }
    
    .btn-delete:active {
      background-color: #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Loggy - Monitor Konkurencji</h1>
    
    <div class="nav">
      <button onclick="showView('list')" class="active" id="btn-list">Aktualna Lista</button>
      <button onclick="showView('update')" id="btn-update">Aktualizacja Listy</button>
    </div>
    
    <!-- Widok: Aktualna Lista -->
    <div id="view-list" class="view active">
      <div class="controls">
        <button class="btn btn-success" onclick="loadLinks()">üîÑ Od≈õwie≈º</button>
        <div class="info" style="margin-top: 10px;">
          ‚ö° Automatyczne sprawdzanie jest aktywne - serwer ciƒÖgle monitoruje linki w tle
        </div>
      </div>
      
      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Wszystkie linki</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-enemy">0</div>
          <div class="stat-label">Konkurencja</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-pending">0</div>
          <div class="stat-label">Sprawdzane</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-ended">0</div>
          <div class="stat-label">Zako≈Ñczone</div>
        </div>
      </div>
      
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>URL</th>
              <th>Status</th>
              <th>B≈ÇƒÖd</th>
              <th>Komentarz</th>
              <th>Ostatnio sprawdzano</th>
              <th class="checkbox-cell">Obs≈Çu≈ºone</th>
              <th class="checkbox-cell">Usu≈Ñ</th>
            </tr>
          </thead>
          <tbody id="links-tbody">
            <tr>
              <td colspan="7" class="loading">≈Åadowanie...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Widok: Aktualizacja Listy -->
    <div id="view-update" class="view">
      <div class="controls">
        <button class="btn btn-primary" onclick="updateLinks()">üíæ AKTUALIZUJ</button>
        <div class="info">
          Wklej listƒô link√≥w (jeden na liniƒô). Nowe linki zostanƒÖ dodane, brakujƒÖce usuniƒôte.<br>
          <strong>üí° Automatyzacja:</strong> Je≈õli link nie zawiera s≈Çowa "offers", zostanie automatycznie dodane "/offers" na ko≈Ñcu.<br>
          <strong>üóëÔ∏è Usuwanie wszystkich:</strong> Pozostaw pole puste aby usunƒÖƒá wszystkie linki z systemu.
        </div>
      </div>
      
      <textarea id="urls-textarea" placeholder="https://example.com/page1&#10;https://example.com/page2&#10;https://example.com/page3" 
                onpaste="setTimeout(processUrlsInTextarea, 10)" 
                onblur="processUrlsInTextarea()"></textarea>
      
      <div id="update-result"></div>
    </div>
  </div>

  <script>
    // ============== NAVIGATION ==============
    let refreshInterval = null;
    
    function showView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      
      document.getElementById(`view-${viewName}`).classList.add('active');
      document.getElementById(`btn-${viewName}`).classList.add('active');
      
      // ZarzƒÖdzaj automatycznym od≈õwie≈ºaniem
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
      
      if (viewName === 'list') {
        loadLinks();
        // Uruchom auto-refresh co 60 sekund tylko dla widoku list
        // WY≈ÅƒÑCZONE: refreshInterval = setInterval(() => {
        //   loadLinks();
        // }, 15000);
      } else if (viewName === 'update') {
        loadLinksForUpdate();
      }
    }
    
    // ============== AKTUALNA LISTA ==============
    async function loadLinks() {
      const tbody = document.getElementById('links-tbody');
      tbody.innerHTML = '<tr><td colspan="7" class="loading">≈Åadowanie...</td></tr>';
      
      try {
        const res = await fetch('/api/links');
        let links = await res.json();
        
        if (links.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="loading">Brak link√≥w. Dodaj nowe w zak≈Çadce "Aktualizacja Listy".</td></tr>';
          updateStats(links);
          return;
        }
        
        // Sortowanie: konkurencja na g√≥rze, potem aktywne, na ko≈Ñcu zako≈Ñczone
        links.sort((a, b) => {
          // Najpierw konkurencja
          if (a.enemy && !b.enemy) return -1;
          if (!a.enemy && b.enemy) return 1;
          
          // Potem zako≈Ñczone na koniec
          if (a.ended && !b.ended) return 1;
          if (!a.ended && b.ended) return -1;
          
          // W ramach tej samej kategorii sortuj po dacie modyfikacji
          const dateA = new Date(a.modified || a.created || 0);
          const dateB = new Date(b.modified || b.created || 0);
          return dateB - dateA;
        });
        
        tbody.innerHTML = links.map(link => `
          <tr ${link.ended ? 'style="opacity: 0.6; background-color: #f8f9fa;"' : ''}>
            <td class="url-cell">
              <a href="${link.url}" target="_blank" class="url-link">${link.url}</a>
            </td>
            <td>
              ${getStatusBadge(link)}
            </td>
            <td>${link.error ? `<span style="color: #dc3545; font-size: 12px;">${link.error}</span>` : '-'}</td>
            <td class="comment-cell">
              <input type="text" class="comment-input" 
                     value="${link.comment ? escapeHtml(link.comment) : ''}"
                     placeholder="Dodaj komentarz..."
                     onkeydown="handleCommentKeydown(event, '${encodeURIComponent(link.url)}')"
                     onblur="saveCommentOnBlur(event, '${encodeURIComponent(link.url)}')">
            </td>
            <td>${formatDate(link.modified || link.created)}</td>
            <td class="checkbox-cell">
              <input type="checkbox" 
                     ${link.checked ? 'checked' : ''} 
                     onchange="toggleChecked('${encodeURIComponent(link.url)}', this.checked)">
            </td>
            <td class="checkbox-cell">
              <button class="btn-delete" 
                      onclick="deleteLink('${encodeURIComponent(link.url)}', ${link.ended}, this)"
                      title="Usu≈Ñ link">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        `).join('');
        
        updateStats(links);
      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="7" class="error">B≈ÇƒÖd: ${err.message}</td></tr>`;
      }
    }
    
    function getStatusBadge(link) {
      if (link.ended) {
        return '<span class="status-badge status-error">üîö Zako≈Ñczone</span>';
      } else if (link.enemy) {
        return '<span class="status-badge status-enemy">‚ö†Ô∏è Konkurencja</span>';
      } else if (link.error) {
        return '<span class="status-badge status-error">‚ö†Ô∏è B≈ÇƒÖd</span>';
      } else {
        return '<span class="status-badge status-ok">‚úì OK</span>';
      }
    }
    
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('pl-PL', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function updateStats(links) {
      const total = links.length;
      const enemy = links.filter(l => l.enemy).length;
      const ended = links.filter(l => l.ended).length;
      const pending = links.filter(l => !l.enemy && !l.ended && !l.checked).length;
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-enemy').textContent = enemy;
      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-ended').textContent = ended;
    }
    
    function updateStatsFromDOM() {
      const tbody = document.getElementById('links-tbody');
      const rows = tbody.querySelectorAll('tr');
      
      let total = 0;
      let enemy = 0;
      let ended = 0;
      let pending = 0;
      
      rows.forEach(row => {
        // Pomi≈Ñ wiersze z komunikatami (loading, error, etc.)
        if (row.cells.length < 7) return;
        
        total++;
        
        const statusCell = row.cells[1];
        const checkboxCell = row.cells[5];
        
        if (statusCell.textContent.includes('Konkurencja')) {
          enemy++;
        } else if (statusCell.textContent.includes('Zako≈Ñczone')) {
          ended++;
        } else {
          const checkbox = checkboxCell.querySelector('input[type="checkbox"]');
          if (checkbox && !checkbox.checked) {
            pending++;
          }
        }
      });
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-enemy').textContent = enemy;
      document.getElementById('stat-pending').textContent = pending;
      document.getElementById('stat-ended').textContent = ended;
    }
    
    async function toggleChecked(url, checked) {
      try {
        await fetch(`/api/links/${url}/check`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ checked })
        });
      } catch (err) {
        alert('B≈ÇƒÖd aktualizacji: ' + err.message);
        loadLinks(); // Od≈õwie≈º
      }
    }
    
    async function deleteLink(encodedUrl, isEnded = false, buttonElement = null) {
      const url = decodeURIComponent(encodedUrl);
      
      // Dla zako≈Ñczonych ofert nie pytaj o potwierdzenie
      if (!isEnded && !confirm(`Czy na pewno chcesz usunƒÖƒá ten link?\n\n${url}`)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/links/${encodedUrl}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        // Usu≈Ñ wiersz z DOM zamiast od≈õwie≈ºaƒá ca≈ÇƒÖ stronƒô
        if (buttonElement) {
          const row = buttonElement.closest('tr');
          if (row) {
            row.style.transition = 'opacity 0.3s ease-out';
            row.style.opacity = '0';
            setTimeout(() => {
              row.remove();
              // Aktualizuj statystyki po usuniƒôciu
              updateStatsFromDOM();
            }, 300);
          }
        } else {
          // Fallback - od≈õwie≈º je≈õli nie ma referencji do przycisku
          loadLinks();
        }
        
      } catch (err) {
        alert('B≈ÇƒÖd usuwania linku: ' + err.message);
      }
    }
    
    // ============== AKTUALIZACJA LISTY ==============
    function processUrlsInTextarea() {
      const textarea = document.getElementById('urls-textarea');
      const urls = textarea.value
        .split('\n')
        .map(url => {
          const trimmedUrl = url.trim();
          if (trimmedUrl.length === 0) return url; // Zachowaj puste linie
          
          // Je≈õli URL nie zawiera s≈Çowa "offers", dodaj /offers na ko≈Ñcu
          if (!trimmedUrl.includes('offers')) {
            // Usu≈Ñ ko≈Ñcowy slash je≈õli istnieje, a nastƒôpnie dodaj /offers
            const processedUrl = trimmedUrl.replace(/\/$/, '') + '/offers';
            return url.replace(trimmedUrl, processedUrl); // Zachowaj oryginalne bia≈Çe znaki
          }
          return url;
        })
        .join('\n');
      
      // Aktualizuj textarea tylko je≈õli co≈õ siƒô zmieni≈Ço
      if (textarea.value !== urls) {
        const cursorPos = textarea.selectionStart;
        textarea.value = urls;
        // Przywr√≥ƒá pozycjƒô kursora (w przybli≈ºeniu)
        textarea.setSelectionRange(cursorPos, cursorPos);
      }
    }

    async function loadLinksForUpdate() {
      try {
        const res = await fetch('/api/links');
        const links = await res.json();
        
        const urls = links.map(l => l.url).join('\n');
        document.getElementById('urls-textarea').value = urls;
      } catch (err) {
        console.error('Error loading links:', err);
      }
    }
    
    async function updateLinks() {
      const textarea = document.getElementById('urls-textarea');
      const urls = textarea.value
        .split('\n')
        .map(u => u.trim())
        .filter(u => u.length > 0)
        .map(url => {
          // Je≈õli URL nie zawiera s≈Çowa "offers", dodaj /offers na ko≈Ñcu
          if (!url.includes('offers')) {
            // Usu≈Ñ ko≈Ñcowy slash je≈õli istnieje, a nastƒôpnie dodaj /offers
            return url.replace(/\/$/, '') + '/offers';
          }
          return url;
        });
      
      // Pozw√≥l na puste listy - usuniƒôcie wszystkich link√≥w
      if (urls.length === 0 && !confirm('Lista jest pusta. Czy na pewno chcesz usunƒÖƒá wszystkie linki?')) {
        return;
      }
      
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Aktualizowanie...';
      
      try {
        const res = await fetch('/api/links/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ urls })
        });
        
        const result = await res.json();
        
        document.getElementById('update-result').innerHTML = `
          <div class="info" style="background: #d4edda; border-color: #28a745; color: #155724; margin-top: 20px;">
            <strong>‚úì Aktualizacja zako≈Ñczona!</strong><br>
            Dodano: ${result.added}<br>
            Usuniƒôto: ${result.removed}<br>
            Razem link√≥w: ${result.total}
          </div>
        `;
        
        setTimeout(() => {
          document.getElementById('update-result').innerHTML = '';
        }, 5000);
      } catch (err) {
        document.getElementById('update-result').innerHTML = `
          <div class="error" style="margin-top: 20px;">
            B≈ÇƒÖd: ${err.message}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üíæ AKTUALIZUJ';
      }
    }
    
    // ============== KOMENTARZE ==============
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Globalna zmienna do przechowywania oryginalnych warto≈õci
    let originalCommentValues = {};
    
    function handleCommentKeydown(event, encodedUrl) {
      const input = event.target;
      
      // Zapisz oryginalnƒÖ warto≈õƒá przy pierwszym focusie
      if (!(encodedUrl in originalCommentValues)) {
        originalCommentValues[encodedUrl] = input.value;
      }
      
      if (event.key === 'Enter') {
        event.preventDefault();
        saveComment(encodedUrl, input.value.trim(), input);
      } else if (event.key === 'Escape') {
        // Przywr√≥ƒá oryginalnƒÖ warto≈õƒá
        input.value = originalCommentValues[encodedUrl] || '';
        input.blur();
      }
    }
    
    function saveCommentOnBlur(event, encodedUrl) {
      const input = event.target;
      const currentValue = input.value.trim();
      const originalValue = originalCommentValues[encodedUrl] || '';
      
      // Zapisz tylko je≈õli warto≈õƒá siƒô zmieni≈Ça
      if (currentValue !== originalValue.trim()) {
        saveComment(encodedUrl, currentValue, input);
      }
    }
    
    async function saveComment(encodedUrl, comment, inputElement) {
      try {
        const response = await fetch(`/api/links/${encodedUrl}/comment`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment: comment })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // Zaktualizuj oryginalnƒÖ warto≈õƒá po udanym zapisaniu
        originalCommentValues[encodedUrl] = comment;
        
      } catch (err) {
        alert('B≈ÇƒÖd zapisywania komentarza: ' + err.message);
        // Przywr√≥ƒá oryginalnƒÖ warto≈õƒá w przypadku b≈Çƒôdu
        inputElement.value = originalCommentValues[encodedUrl] || '';
      }
    }

    // ============== INIT ==============
    window.addEventListener('DOMContentLoaded', () => {
      loadLinks();
    });
  </script>
</body>
</html>
